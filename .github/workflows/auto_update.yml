#!/bin/bash

# Configuration
SCRIPT_NAME="merge_playlists.py"
WORKFLOW_DIR=".github/workflows"
WORKFLOW_FILE="$WORKFLOW_DIR/update.yml"
REQUIREMENTS_FILE="requirements.txt"

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${CYAN}--- IPTV Cloud Auto-Updater Setup ---${NC}"

# 1. Check if Python script exists
if [ ! -f "$SCRIPT_NAME" ]; then
    echo -e "${RED}Error: $SCRIPT_NAME not found!${NC}"
    echo "Please save the Python script from the previous message as '$SCRIPT_NAME' in this folder."
    exit 1
fi

# 2. Ask for GitHub Repo URL
echo -e "${GREEN}Enter your empty GitHub Repository URL (ending in .git):${NC}"
read -r REPO_URL

if [[ -z "$REPO_URL" ]]; then
    echo -e "${RED}Error: URL cannot be empty.${NC}"
    exit 1
fi

# 3. Create Requirements file
echo "Creating $REQUIREMENTS_FILE..."
echo "requests" > $REQUIREMENTS_FILE
echo "beautifulsoup4" >> $REQUIREMENTS_FILE
echo "rapidfuzz" >> $REQUIREMENTS_FILE

# 4. Create GitHub Actions Workflow
echo "Creating GitHub Actions Workflow..."
mkdir -p "$WORKFLOW_DIR"

cat <<EOF > "$WORKFLOW_FILE"
name: IPTV Auto-Update

on:
  schedule:
    # Runs every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allows manual button click run

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run IPTV Merger
      env:
        # Pass the GITHUB_TOKEN automatically provided by Actions
        GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: \${{ github.repository }}
      run: |
        python $SCRIPT_NAME --one-shot --auto-repair

    - name: Commit and Push changes
      run: |
        git config --global user.name "IPTV-Bot"
        git config --global user.email "actions@github.com"
        
        # Check if there are changes to push
        if [[ -n \$(git status -s) ]]; then
          git add playlist.m3u channels.json discovered_sources.json changes.json
          git commit -m "Auto-update: \$(date)"
          git push
        else
          echo "No changes to commit"
        fi
EOF

# 5. Initialize Git and Push
echo -e "${CYAN}Initializing Git repository...${NC}"

# Remove old git folder if it exists to avoid conflicts
rm -rf .git

git init
git branch -M main
git remote add origin "$REPO_URL"

echo "Adding files..."
git add "$SCRIPT_NAME" "$REQUIREMENTS_FILE" ".github"

echo "Committing..."
git commit -m "Initial setup for Cloud Auto-Update"

echo -e "${GREEN}Pushing to GitHub...${NC}"
echo -e "${CYAN}NOTE: When asked for 'Username', use your GitHub username.${NC}"
echo -e "${CYAN}NOTE: When asked for 'Password', paste your Personal Access Token (PAT).${NC}"

git push -u origin main

if [ $? -eq 0 ]; then
    echo -e "${GREEN}Success! Your IPTV script is now on the cloud.${NC}"
    echo "You can now delete Termux, turn off your phone, or switch devices."
    echo "The script will run automatically every 6 hours on GitHub servers."
else
    echo -e "${RED}Push failed. Check your URL and Token.${NC}"
fi
